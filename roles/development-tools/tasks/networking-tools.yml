---
# Install networking and VPN tools

# Include repo codename mapping if not already set
- name: Ensure repo_codename is set
  ansible.builtin.set_fact:
    repo_codename: "{{ repo_codename | default(ansible_distribution_release == 'plucky' | ternary('noble', ansible_distribution_release)) }}"
  when: repo_codename is not defined

- name: Install Tailscale VPN (if 'tailscale' selected in Development > Networking Tools)
  block:
    - name: Create keyring directory
      ansible.builtin.file:
        path: /usr/share/keyrings
        state: directory
        mode: '0755'
      become: yes

    - name: Download Tailscale GPG key
      ansible.builtin.get_url:
        url: https://pkgs.tailscale.com/stable/ubuntu/{{ repo_codename | default('noble') }}.noarmor.gpg
        dest: /usr/share/keyrings/tailscale.gpg
        mode: '0644'
      become: yes

    - name: Add Tailscale repository with signed-by
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/tailscale.gpg] https://pkgs.tailscale.com/stable/ubuntu {{ repo_codename | default('noble') }} main"
        state: present
        filename: tailscale
      become: yes

    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: yes
      become: yes

    - name: Install Tailscale GUI (Trayscale)
      flatpak:
        name: dev.deedles.Trayscale
        state: present
      become: yes
      when: enable_flatpak | default(true)
  when: "'tailscale' in devtools_networking_tools"

- name: Install ZeroTier mesh VPN (if 'zerotier' selected in Development > Networking Tools)
  block:
    - name: Download ZeroTier GPG key
      ansible.builtin.get_url:
        url: https://raw.githubusercontent.com/zerotier/ZeroTierOne/master/doc/contact%40zerotier.com.gpg
        dest: /tmp/zerotier.asc
      become: yes

    - name: Convert and install ZeroTier GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/zerotier.asc > /usr/share/keyrings/zerotier.gpg
        chmod 644 /usr/share/keyrings/zerotier.gpg
      args:
        creates: /usr/share/keyrings/zerotier.gpg
      become: yes

    - name: Add ZeroTier repository with signed-by
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/zerotier.gpg] https://download.zerotier.com/debian/{{ ubuntu_fallback_codename }} {{ ubuntu_fallback_codename }} main"
        state: present
        filename: zerotier
      become: yes

    - name: Install ZeroTier
      ansible.builtin.apt:
        name: zerotier-one
        state: present
        update_cache: yes
      become: yes

    - name: Install ZeroTier GUI
      snap:
        name: zerotier-gui
        state: present
      become: yes
      when: enable_snap | default(true)
  when: "'zerotier' in devtools_networking_tools"

- name: Install WireGuard VPN and GUI (if 'wireguard' selected in Development > Networking Tools)
  block:
    - name: Install WireGuard
      ansible.builtin.apt:
        name:
          - wireguard
          - wireguard-tools
        state: present
      become: yes

    - name: Install WireGuard GUI options
      ansible.builtin.apt:
        name: "{{ item }}"
        state: present
      become: yes
      loop:
        - network-manager-openvpn-gnome
      when: desktop_environment == 'gnome'
  when: "'wireguard' in devtools_networking_tools"

- name: Install NetBird mesh VPN (if 'netbird' selected in Development > Networking Tools)
  block:
    - name: Download NetBird installer
      ansible.builtin.get_url:
        url: https://pkgs.netbird.io/install.sh
        dest: /tmp/netbird-install.sh
        mode: '0755'
      become: yes

    - name: Install NetBird
      ansible.builtin.shell: /tmp/netbird-install.sh
      become: yes
      environment:
        NB_USE_SYSTEM_DAEMON: "yes"
  when: "'netbird' in devtools_networking_tools"

- name: Install OpenVPN and GUI (if 'openvpn' selected in Development > Networking Tools)
  block:
    - name: Install OpenVPN
      ansible.builtin.apt:
        name:
          - openvpn
          - network-manager-openvpn
          - network-manager-openvpn-gnome
        state: present
      become: yes
  when: "'openvpn' in devtools_networking_tools"

- name: Install Cockpit web-based server manager (if 'cockpit' selected in Development > Networking Tools)
  block:
    - name: Install Cockpit
      ansible.builtin.apt:
        name:
          - cockpit
          - cockpit-podman
          - cockpit-networkmanager
          - cockpit-packagekit
          - cockpit-storaged
        state: present
      become: yes

    - name: Enable Cockpit service
      ansible.builtin.systemd:
        name: cockpit.socket
        enabled: yes
        state: started
      become: yes

    - name: Open firewall for Cockpit
      ufw:
        rule: allow
        port: '9090'
        proto: tcp
      become: yes
      when: enable_firewall | default(true)
  when: "'cockpit' in devtools_networking_tools"

- name: Install Webmin web-based system administration (if 'webmin' selected in Development > Networking Tools)
  block:
    - name: Download Webmin GPG key
      ansible.builtin.get_url:
        url: http://www.webmin.com/jcameron-key.asc
        dest: /tmp/webmin.asc
      become: yes

    - name: Convert and install Webmin GPG key
      ansible.builtin.shell: |
        gpg --dearmor < /tmp/webmin.asc > /usr/share/keyrings/webmin.gpg
        chmod 644 /usr/share/keyrings/webmin.gpg
      args:
        creates: /usr/share/keyrings/webmin.gpg
      become: yes

    - name: Add Webmin repository with signed-by
      apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/webmin.gpg] https://download.webmin.com/download/repository sarge contrib"
        state: present
        filename: webmin
      become: yes

    - name: Install Webmin
      ansible.builtin.apt:
        name: webmin
        state: present
        update_cache: yes
      become: yes

    - name: Open firewall for Webmin
      ufw:
        rule: allow
        port: '10000'
        proto: tcp
      become: yes
      when: enable_firewall | default(true)
  when: "'webmin' in devtools_networking_tools"
