#!/bin/bash
# System health check script - runs after boot
# Generated by Ansible

echo "=== System Boot Health Check Report ==="
echo "Date: $(date)"
echo "Hostname: $(hostname)"
echo "Kernel: $(uname -r)"
echo

# Check boot time
echo "=== Boot Performance ==="
systemd-analyze || echo "systemd-analyze not available"
echo

# Check for kernel errors
echo "=== Kernel Errors (last 50 lines) ==="
dmesg | grep -iE "error|fail|unable|cannot|warn" | grep -v "ACPI" | tail -50 || echo "No kernel errors detected"
echo

{% if health_check_storage %}
# Run storage health check
echo "=== Storage Health ==="
/usr/local/bin/check-storage-health
echo
{% endif %}

{% if health_check_graphics %}
# Run graphics health check
echo "=== Graphics Health ==="
/usr/local/bin/check-graphics-health
echo
{% endif %}

{% if health_check_services %}
# Run service health check
echo "=== Service Health ==="
/usr/local/bin/check-service-health
echo
{% endif %}

# Check system resources
echo "=== System Resources ==="
echo "Memory usage:"
free -h
echo
echo "Disk usage:"
df -h | grep -vE "tmpfs|devtmpfs|loop"
echo
echo "CPU load:"
uptime
echo

# Log results
echo "=== Health check completed at $(date) ==="

{% if send_boot_alerts %}
# Send alerts if errors found
if dmesg | grep -qiE "error|fail" || systemctl is-failed --quiet; then
    /usr/local/bin/notify-boot-errors
fi
{% endif %}