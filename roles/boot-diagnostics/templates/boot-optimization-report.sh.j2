#!/bin/bash
# Boot optimization report
# Generated by Ansible

echo "==================================="
echo "   BOOT OPTIMIZATION REPORT"
echo "==================================="
echo "Generated: $(date)"
echo

# Current boot time
echo "Current Boot Time Analysis:"
systemd-analyze
echo

# Critical chain
echo "Critical Boot Chain:"
systemd-analyze critical-chain
echo

# Blame (top 20 slowest services)
echo "Top 20 Slowest Services:"
systemd-analyze blame | head -20
echo

# Boot time history
if [ -f /var/log/boot-times.log ]; then
    echo "Boot Time History (last 10 boots):"
    tail -10 /var/log/boot-times.log
    echo
    
    # Calculate average
    echo "Average boot time:"
    awk -F'Boot time: ' '{print $2}' /var/log/boot-times.log | \
        grep -o '[0-9.]*' | \
        awk '{sum+=$1; count++} END {if(count>0) printf "%.2fs (from %d samples)\n", sum/count, count}'
    echo
fi

# Services that might be disabled
echo "Services that could potentially be disabled for faster boot:"
echo "(Review carefully before disabling)"
echo

# Snap services
if systemctl is-enabled snapd.service >/dev/null 2>&1; then
    echo "- snapd.service (if not using snap packages)"
    echo "- snapd.seeded.service"
fi

# Plymouth
if systemctl is-enabled plymouth-quit-wait.service >/dev/null 2>&1; then
    echo "- plymouth-quit-wait.service (boot splash screen)"
fi

# NetworkManager wait
if systemctl is-enabled NetworkManager-wait-online.service >/dev/null 2>&1; then
    echo "- NetworkManager-wait-online.service (if network not needed at boot)"
fi

# ModemManager
if systemctl is-enabled ModemManager.service >/dev/null 2>&1; then
    echo "- ModemManager.service (if not using mobile broadband)"
fi

echo
echo "To disable a service: sudo systemctl disable <service-name>"
echo "To mask a service: sudo systemctl mask <service-name>"
echo

# Recommendations
echo "Optimization Recommendations:"
echo "1. Review and disable unnecessary services"
echo "2. Consider using systemd-analyze plot > boot.svg for visual analysis"
echo "3. Check for failing services with: systemctl --failed"
echo "4. Reduce journal size if needed: sudo journalctl --vacuum-time=1w"
echo "5. Consider adding 'noresume' to kernel parameters if not using hibernation"

read -p "Press Enter to exit..."